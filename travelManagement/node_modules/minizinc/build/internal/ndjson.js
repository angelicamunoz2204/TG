"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function streamBody(r, parseChunk, onFinish) {
    var reader = r.body.getReader();
    var decoder = new TextDecoder();
    var output = '';
    var readBlock = function (_a) {
        var done = _a.done, value = _a.value;
        if (done) {
            parseChunk(output, true);
            return onFinish();
        }
        output = parseChunk(output + decoder.decode(value), false);
        return reader.read().then(readBlock);
    };
    return reader.read().then(readBlock);
}
exports.streamBody = streamBody;
function parseNDJSON(r, onChunk, onFinish) {
    var parseChunk = function (value, ended) {
        var start = 0;
        var end = -1;
        do {
            end = value.indexOf('\n', start);
            if (end < 0 && ended) {
                end = value.length;
            }
            if (end < 0) {
                break;
            }
            var line = value.slice(start, end);
            start = end + 1;
            if (line.trim().length > 0) {
                var obj = JSON.parse(line);
                onChunk(obj);
            }
        } while (start < value.length);
        return start < value.length ? value.slice(start) : '';
    };
    return streamBody(r, parseChunk, onFinish);
}
exports.parseNDJSON = parseNDJSON;
//# sourceMappingURL=ndjson.js.map